<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transfer Learning</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>
    <style>
      .btn-custom {
        background-color: orangered;
        color: white;
      }
      .btn-custom:hover {
        background-color: darkorange;
        color: white;
        transition: 0.6s ease-in;
      }
      .card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }
      .container {
        max-width: 600px;
        margin-top: 50px;
      }
      textarea {
        resize: none;
      }
      textarea:focus {
        outline: none;
      }
      .form-label {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card p-4 mx-auto" style="max-width: 800px; margin-top: 40px">
        <h3 class="text-center mb-3">TensorFlow ile Duygu Analizi</h3>
        <p class="text-muted text-center">Duygu Analizi Cümlesi</p>
        <div class="mb-3">
          <label for="inputText" class="form-label">Cümle Girin:</label>
          <textarea
            class="form-control"
            id="inputText"
            rows="3"
            placeholder="Örnek Cümleler"
          ></textarea>
        </div>
        <div class="d-grid">
          <button id="predictBtn" class="btn btn-custom">Analiz Et</button>
        </div>
        <div
          id="loading"
          class="mt-4 text-center text-secondary"
          style="display: block"
        >
          Yükleniyor...
        </div>
        <div id="result" class="mt-4 text-center fw-bold"></div>
      </div>
      <div>
        <h6 style="text-align: center; margin-top: 10px">Eğitim Logları</h6>
        <div
          id="log"
          class="border rounded p-2 bg-light mt-3"
          style="height: 200px; overflow-y: auto"
        ></div>
      </div>
    </div>
  </body>
  <script>
    var multi =
      "https://www.kaggle.com/models/google/universal-sentence-encoder/TensorFlow2/multilingual/2";
    var model;
    var encoder;
    var trainingData = [];
    function logMessage(message) {
      var log = document.getElementById("log");
      log.innerText += message + "\n";
      log.scrollTop = log.scrollHeight;
    }
    $(document).ready(function () {
      loadModel();
      $("#loading").show().text("Model ve Veriler yükleniyor...");
    });
    async function loadModel() {
      logMessage("Model yükleniyor...");
      $("#loading").show().text("Model ve Veriler yükleniyor...");
      try {
        // encoder = await use.load();
        encoder = await use.load(multi);
        logMessage(
          "Universal Sentence Encoder yüklendi. Türkçe dil desteği aktif."
        );
        var [textArray, labelArray] = await files(
          "yorumlar.txt",
          "etiketler.txt"
        );
        logMessage(`${textArray.length} eğitim örneği yüklendi.`);
        trainingData = textArray.map((text, index) => ({
          text: text,
          oneHotLabel: labelArray[index],
        }));
        model = createModel();
        logMessage("Model oluşturuldu ve derlendi.");
        await trainModel(trainingData);
      } catch (error) {
        logMessage("Hata oluştu: " + error);
      }
    }
    async function files(textFile, labelFile) {
      logMessage("TXT dosyaları yükleniyor...");
      var textResponse = await fetch(textFile);
      var textData = await textResponse.text();
      var textLines = textData.split("\n").map((line) => line.trim());
      var labelResponse = await fetch(labelFile);
      var labelData = await labelResponse.text();
      var labelLines = labelData
        .split("\n")
        .map((line) => line.trim())
        .filter((line) => line !== "");
      logMessage("Etiketler yükleniyor...");
      var labelRes = await fetch(labelFile);
      var labelData = await labelRes.text();
      var labelLines = labelData
        .split("\n")
        .map((line) => line.trim())
        .filter((line) => line !== "")
        .map((line) => {
          var cleanLine = line.replace(/[\[\]\s]/g, "");
          return cleanLine.split(",").map(Number);
        });
      return [textLines, labelLines];
    }
    function createModel() {
      var model = tf.sequential();
      model.add(
        tf.layers.dense({ inputShape: [512], units: 256, activation: "relu" })
      );
      model.add(tf.layers.dense({ units: 2, activation: "softmax" }));
      model.compile({
        optimizer: tf.train.adam(0.001),
        loss: "categoricalCrossentropy",
        metrics: ["accuracy"],
      });
      return model;
    }
    async function trainModel(trainingData) {
      logMessage("Veri hazırlanıyor...");
      var sentences = trainingData.map((item) => item.text);
      var labels = trainingData.map((item) => item.oneHotLabel);
      var embeddings = await encoder.embed(sentences);
      var labelTensor = tf.tensor2d(labels);
      logMessage("Model eğitiliyor...");
      await model.fit(embeddings, labelTensor, {
        epochs: 50,
        batchSize: 32,
        shuffle: true,
        callbacks: {
          onEpochEnd: (epoch, logs) => {
            logMessage(
              `Epoch ${epoch + 1}: Loss = ${logs.loss.toFixed(
                4
              )}, Accuracy = ${logs.acc.toFixed(4)}`
            );
          },
        },
      });
      logMessage("Model eğitimi tamamlandı.");
      $("#loading").hide();
      $("#result").text("Model hazır! Analiz etmeye başlayabilirsiniz.");
    }
    async function predictText() {
      var text = $("#inputText").val().trim();
      if (text === "") {
        $("#result").text("Lütfen bir cümle girin.");
        return;
      }
      $("#predictBtn").prop("disabled", true).text("Analiz Ediliyor...");
      var embedding = await encoder.embed([text]);
      var prediction = model.predict(embedding);
      var result = prediction.arraySync()[0];
      $("#predictBtn").prop("disabled", false).text("Analiz Et");
      if (result[0] > result[1]) {
        $("#result").text("Olumsuz - Negatif Cümle");
      } else {
        $("#result").text("Olumlu - Pozitif Cümle");
      }
    }
    $("#predictBtn").click(function () {
      predictText();
    });
  </script>
</html>
