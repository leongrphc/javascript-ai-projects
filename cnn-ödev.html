<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediaPipe Görsel Sınıflandırma - Mustafa Özkan</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>
  </head>
  <style>
    #imageWrapper {
      position: relative;
      display: inline-block;
      max-width: 100%;
    }
    #uploadedImage {
      max-width: 100%;
      height: auto;
      display: block;
    }
    #canvasOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }
  </style>
  <body>
    <div class="container mt-5 text-center">
      <h3>MediaPipe Görsel Sınıflandırma - Mustafa Özkan</h3>
      <div class="mb-3">
        <label for="fileInput" class="form-label">Bir resim yükleyin:</label>
        <p class="status"></p>
        <input
          class="form-control"
          type="file"
          id="fileInput"
          accept="image/*"
        />
        <button id="predictBtn" class="btn btn-primary mt-3">Tahmin Et</button>
      </div>
      <div id="result" class="mt-3">
        <h5>Tahmin Sonucu:</h5>
        <p id="predictionText">Henüz bir tahmin yapılmadı.</p>
        <div id="progressContainer" class="progress mt-3" style="display: none">
          <div
            id="progressbar"
            class="progress-bar progress-bar-striped progress-bar-animated"
            role="progressbar"
            aria-valuenow="0"
            aria-valuemin="0"
            aria-valuemax="100"
            style="width: 0%"
          ></div>
        </div>
      </div>
      <div id="imageContainer" class="mt-3">
        <div id="imageWrapper">
          <img
            id="uploadedImage"
            src="#"
            alt="Yüklenen Resim"
            style="max-width: 100%; display: none"
          />
          <canvas id="canvasOverlay" style="display: none"></canvas>
        </div>
      </div>
    </div>
  </body>
  <script type="module">
    import {
      ObjectDetector,
      FilesetResolver,
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";
    var detector;
    const fileInput = document.getElementById("fileInput");
    const predictBtn = document.getElementById("predictBtn");
    const predictionText = document.getElementById("predictionText");
    const uploadedImage = document.getElementById("uploadedImage");
    const canvasOverlay = document.getElementById("canvasOverlay");
    const boundingBoxesDiv = document.getElementById("boundingBoxes");
    const progressContainer = document.getElementById("progressContainer");
    const progressbar = document.getElementById("progressbar");
    const status = document.querySelector(".status");

    fileInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          uploadedImage.src = e.target.result;
          uploadedImage.style.display = "block";
          uploadedImage.onload = () => {
            canvasOverlay.width = uploadedImage.naturalWidth;
            canvasOverlay.height = uploadedImage.naturalHeight;
            canvasOverlay.style.display = "block";
          };
        };
        reader.readAsDataURL(file);
      }
    });

    async function loadModel() {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
      );
      detector = await ObjectDetector.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float32/1/efficientdet_lite0.tflite`,
          delegate: "GPU",
        },
        scoreThreshold: 0.5,
        maxResults: 5,
      });
      if (detector) {
        predictBtn.disabled = false;
        status.textContent = "Model yüklendi. Bir resim seçebilirsiniz.";
      }
    }
    predictBtn.addEventListener("click", async () => {
      if (!fileInput.files.length) {
        alert("Lütfen önce bir resim yükleyin.");
        return;
      }
      const ctx = canvasOverlay.getContext("2d");
      ctx.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
      const originalWidth = uploadedImage.naturalWidth;
      const originalHeight = uploadedImage.naturalHeight;
      const displayedWidth = uploadedImage.clientWidth;
      const displayedHeight = uploadedImage.clientHeight;
      const scaleX = displayedWidth / originalWidth;
      const scaleY = displayedHeight / originalHeight;
      ctx.save();
      ctx.scale(scaleX, scaleY);
      const image = uploadedImage;
      const detections = await detector.detect(image);
      if (detections.detections.length > 0) {
        detections.detections.forEach((detection) => {
          const boundingBox = detection.boundingBox;
          const category = detection.categories[0].categoryName;
          const score = detection.categories[0].score.toFixed(2);
          const color = `hsl(${Math.random() * 360}, 70%, 50%)`;
          ctx.strokeStyle = color;
          ctx.lineWidth = 4 / scaleX;
          ctx.strokeRect(
            boundingBox.originX,
            boundingBox.originY,
            boundingBox.width,
            boundingBox.height
          );
          ctx.font = `${40 / scaleX}px Arial`;
          ctx.fillStyle = color;
          const text = `${category} (${score})`;
          const textWidth = ctx.measureText(text).width;
          const textX = boundingBox.originX;
          const textY =
            boundingBox.originY > 40 / scaleY
              ? boundingBox.originY - 10 / scaleY
              : 40 / scaleY;

          ctx.fillRect(
            textX,
            textY - 35 / scaleY,
            textWidth + 10 / scaleX,
            40 / scaleY
          );
          ctx.fillStyle = "#ffffff";
          ctx.fillText(text, textX + 5 / scaleX, textY - 5 / scaleY);
        });
      }

      ctx.restore();
    });
    loadModel();
  </script>
</html>
